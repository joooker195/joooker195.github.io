<html><head><link rel="import" href="../bower_components/polymer/polymer.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html"><link rel="import" href="../bower_components/app-route/app-location.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/iron-pages/iron-pages.html"><link rel="import" href="../bower_components/iron-list/iron-list.html"><link rel="import" href="../bower_components/iron-selector/iron-selector.html"><link rel="import" href="../bower_components/paper-listbox/paper-listbox.html"><link rel="import" href="../bower_components/paper-item/paper-item.html"><link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html"><link rel="import" href="../bower_components/paper-dialog/paper-dialog.html"><link rel="import" href="../bower_components/paper-fab/paper-fab.html"><link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-view2"><template><style include="shared-styles">:host{display:block;padding:10px;}.card{margin:24px;padding:16px;color:#757575;border-radius:5px;background-color:#fff;box-shadow:0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);}paper-item{max-width:500px;}</style><paper-button raised="" noink="" id="updateCategoryBtn" on-click="updateR">Обновить</paper-button><div class="card"><h4>Добавить покупку</h4><paper-input label="Имя покупки" value="{{ latestItemName }}"></paper-input><paper-dropdown-menu label="Категория"><paper-listbox id="selectCateg" slot="dropdown-content" class="dropdown-content" selected="0"><template is="dom-repeat" items="{{listItems}}"><paper-item>{{ item.categoryName }}</paper-item></template></paper-listbox></paper-dropdown-menu><paper-input label="Количество" type="number" min="0" value="{{ latestCount }}"></paper-input><paper-input label="Цена" type="number" min="0" value="{{ latestPrice }}"></paper-input><paper-input label="Комментарий" value="{{ latestComm }}"></paper-input><div class="buttons"><paper-button on-click="addRecord">Добавить</paper-button></div></div></template><script>Polymer({is:'my-view2',properties:{prop1:{type:String,value:'show-app'},categoryList:{type:Array,value:[]},merList:{type:Array,value:[{merName:'\u043A\u0433'},{merName:'\u043B\u0438\u0442\u0440\u044B'},{merName:'\u0448\u0442\u0443\u043A\u0438'}]},listItems:{type:Array,value:[]}},ready:function(){this.listItems=[],this.latestItemName='',this.latestCount='',this.latestPrice='',this.latestCategoryName='',this.categoryList=[]},addRecord:function(){var c=open.result,d=c.transaction('MyObjectStore','readwrite'),e=d.objectStore('MyObjectStore'),f=this.$.selectCateg.selected;this.latestCategoryName=help[f].categoryName;var g=help[f].id;++ind,console.log('ind: '+ind),e.put({id:ind,itemName:this.latestItemName,categoryName:this.latestCategoryName,categoryID:g,isComplete:!1,count:this.latestCount,price:this.latestPrice,comm:this.latestComm}),this.latestItemName='',this.latestCategoryName='',this.latestPrice='',this.latestComm=''},updateRecords:function(){console.log('---------------------------------------'),this.splice('listItems',0),this.listItems=[];var c=open.result,d=c.transaction('MyObjectStore','readwrite'),e=d.objectStore('MyObjectStore'),f=e.index('itemName');f.openCursor().onsuccess=function(g){if(cursor=g.target.result,cursor){({id:cursor.value.id,itemName:cursor.value.itemName,isComplete:cursor.value.isComplete,categoryID:cursor.value.categoryID,count:cursor.value.count,mer:cursor.value.mer,price:cursor.value.price,comm:cursor.value.comm});console.log('cursor: '+cursor.value.id+' '+cursor.value.itemName+' '+cursor.value.categoryName+' '+cursor.value.categoryID+' '+cursor.value.isComplete+' '+cursor.value.count+' '+cursor.value.mer+' '+cursor.value.price+' '+cursor.value.comm),cursor.continue()}else;},helpS.sort(function(g,h){return g.id-h.id}),this.updateR()},updateR:function(){for(this.splice('listItems',0),this.splice('listItems',0),i=0;i<help.length;i++){var c={id:help[i].id,categoryName:help[i].categoryName,isComplete:help[i].isComplete};this.push('listItems',c)}},updateAfterClick:function(c){for(console.log('categ length: '+c.length),this.splice('categoryList',0),i=0;i<c.length;i++){var d={id:c[i].id,categoryName:c[i].categoryName,isComplete:c[i].isComplete};this.push('categoryList',d)}helpS.length;for(i=0;i<helpS.length;i++){var f=c.findIndex(function(m){return m.id===helpS[i].categoryID});console.log('index   : '+f),-1===f?(helpS.splice(i,1),--i):helpS[i].categoryName=c[f].categoryName}var g=open.result,h=g.transaction('MyObjectStore','readwrite'),j=h.objectStore('MyObjectStore'),k=j.index('categoryName'),l=[];k.openCursor().onsuccess=function(m){if(cursor=m.target.result,cursor){var p=c.findIndex(function(s){return s.id===cursor.value.categoryID});if(-1===p)cursor.delete();else{var q=j.index('itemName'),r=q.get(cursor.value.itemName);r.onsuccess=function(){console.log('---------------------------------------');var t=r.result;t.categoryName=c[p].categoryName;var u=j.put(t);u.onsuccess=function(){console.log('edit')}}}cursor.continue()}else console.log('indexes.length: '+l.length)},this.updateRecords()}});var rep=0,ind=0,cursor,indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB,open=indexedDB.open('MyData2',1);open.onupgradeneeded=function(){var c=open.result,d=c.createObjectStore('MyObjectStore',{keyPath:'id'}),e=d.createIndex('itemName','itemName')},open.onsuccess=function(){var c=open.result,d=c.transaction('MyObjectStore','readwrite'),e=d.objectStore('MyObjectStore'),f=e.index('itemName');f.openCursor().onsuccess=function(g){if(cursor=g.target.result,cursor){var h={id:cursor.value.id,itemName:cursor.value.itemName,categoryName:cursor.value.categoryName,categoryID:cursor.value.categoryID,isComplete:cursor.value.isComplete,count:cursor.value.count,price:cursor.value.price,comm:cursor.value.comm};ind<cursor.value.id&&(ind=cursor.value.id),helpS.push(h),console.log('cursor:  '+cursor.value.itemName+'  '+cursor.value.categoryName+' '+cursor.value.categoryID+' '+cursor.value.count+' '+cursor.value.price+' '+cursor.value.comm),cursor.continue()}else console.log('ind: '+ind)}};var helpS=[],openCategory=window.indexedDB.open('MyData',1);openCategory.onupgradeneeded=function(){var c=openCategory.result,d=c.createObjectStore('MyObjectStore',{keyPath:'id'}),e=d.createIndex('categoryName','categoryName')};var help=[];openCategory.onsuccess=function(){var c=openCategory.result,d=c.transaction('MyObjectStore','readwrite'),e=d.objectStore('MyObjectStore'),f=e.index('categoryName');f.openCursor().onsuccess=function(g){if(cursor=g.target.result,cursor){var h={id:cursor.value.id,categoryName:cursor.value.categoryName,isComplete:cursor.value.isComplete};ind<cursor.value.id&&(ind=cursor.value.id),help.push(h),console.log('cursor: '+cursor.value.id+' '+cursor.value.categoryName+' '+cursor.value.isComplete),cursor.continue()}else console.log('ind: '+ind)}};</script></dom-module></body></html>